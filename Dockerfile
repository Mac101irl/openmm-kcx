
# --- Stage 1: Build Environment ---
FROM ubuntu:22.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive
ENV MAMBA_ROOT_PREFIX=/opt/conda
ENV PATH=$MAMBA_ROOT_PREFIX/bin:$PATH

RUN apt-get update && apt-get install -y --no-install-recommends     build-essential     wget     ca-certificates     bzip2     && rm -rf /var/lib/apt/lists/*

# Install Micromamba
RUN wget -qO- https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba     && mv bin/micromamba /usr/local/bin/     && mkdir -p /opt/conda     && chmod -R 777 /opt/conda

# Stage 1: AmberTools
RUN micromamba install -y -p /opt/conda -c conda-forge     python=3.10     ambertools     && micromamba clean -afy

# Stage 2: OpenMM and CUDA toolkit
RUN micromamba install -y -p /opt/conda -c conda-forge     openmm     cudatoolkit=11.8     && micromamba clean -afy

# Stage 3: Analysis tools
RUN micromamba install -y -p /opt/conda -c conda-forge     parmed     mdtraj     numpy     scipy     pandas     matplotlib     openmmforcefields     && micromamba clean -afy

# Cleanup
RUN find /opt/conda -type f -name '*.a' -delete     && find /opt/conda -type f -name '*.pyc' -delete     && find /opt/conda -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true     && rm -rf /opt/conda/pkgs/*     && rm -rf /opt/conda/share/doc     && rm -rf /opt/conda/share/man     && rm -rf /opt/conda/include

# --- Stage 2: Runtime Image ---
FROM docker.io/nvidia/cuda:11.8.0-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN mkdir -p /usr/share/man/man1 /usr/share/man/man7     && apt-get update && apt-get install -y --no-install-recommends     libgomp1     libxrender1     libxext6     libgl1     libglib2.0-0     procps     ca-certificates     && apt-get clean     && rm -rf /var/lib/apt/lists/*     && rm -rf /var/cache/apt/archives/*

COPY --from=builder /opt/conda /opt/conda

ENV PATH="/opt/conda/bin:$PATH"     AMBERHOME="/opt/conda"     LD_LIBRARY_PATH="/opt/conda/lib:$LD_LIBRARY_PATH"     PYTHONUNBUFFERED=1     OPENMM_DEFAULT_PLATFORM="CUDA"     CUDA_PRECISION="mixed"     CUDA_CACHE_DISABLE=0     CUDA_CACHE_MAXSIZE=2147483648     NVIDIA_VISIBLE_DEVICES=all     NVIDIA_DRIVER_CAPABILITIES=compute,utility

WORKDIR /app

RUN mkdir -p /app/kcx_params /app/inputs /app/out

# --- EMBEDDED FILES ---
# We use base64 decoding to avoid escaping issues

# kcx.lib
RUN echo "ISEgaW5kZXggYXJyYXkgc3RyDQogIktDWCINCiFlbnRyeS5LQ1gudW5pdC5hdG9tcyB0YWJsZSBzdHIgbmFtZSBzdHIgdHlwZSBpbnQgdHlwZXggaW50IHJlZXNzaW9uIGludCBmbGFncyBpbnQgc2VxIGludCBlbG1udCBkYmwgY2hnDQogIk4iICJOIiAwIDEgMTMxMDcyIDEgNyAtMC40MTU3DQogIkgiICJIIiAwIDEgMTMxMDcyIDIgMSAwLjI3MTkNCiAiQ0EiICJDWCIgMCAxIDEzMTA3MiAzIDYgLTAuMDM1MQ0KICJIQSIgIkgxIiAwIDEgMTMxMDcyIDQgMSAwLjEwNDgNCiAiQ0IiICJDMyIgMCAxIDEzMTA3MiA1IDYgLTAuMDA5NA0KICJIQjIiICJIQyIgMCAxIDEzMTA3MiA2IDEgMC4wMzYyDQogIkhCMyIgIkhDIiAwIDEgMTMxMDcyIDcgMSAwLjAzNjINCiAiQ0ciICJDMyIgMCAxIDEzMTA3MiA4IDYgMC4wMTg3DQogIkhHMiIgIkhDIiAwIDEgMTMxMDcyIDkgMSAwLjAxMDMNCiAiSEczIiAiSEMiIDAgMSAxMzEwNzIgMTAgMSAwLjAxMDMNCiAiQ0QiICJDMyIgMCAxIDEzMTA3MiAxMSA2IC0wLjA0NzkNCiAiSEQyIiAiSEMiIDAgMSAxMzEwNzIgMTIgMSAwLjA2MjENCiAiSEQzIiAiSEMiIDAgMSAxMzEwNzIgMTMgMSAwLjA2MjENCiAiQ0UiICJDMyIgMCAxIDEzMTA3MiAxNCA2IDAuMDk2MA0KICJIRTIiICJIUCIgMCAxIDEzMTA3MiAxNSAxIDAuMDg4OQ0KICJIRTMiICJIUCIgMCAxIDEzMTA3MiAxNiAxIDAuMDg4OQ0KICJOWiIgIk4iIDAgMSAxMzEwNzIgMTcgNyAtMC40Nzg2DQogIkhaIiAiSCIgMCAxIDEzMTA3MiAxOCAxIDAuMzQyMQ0KICJDWSIgIkNZIiAwIDEgMTMxMDcyIDE5IDYgMC43MTM2DQogIk9RMSIgIk8yIiAwIDEgMTMxMDcyIDIwIDggLTAuNzU4NA0KICJPUTIiICJPMiIgMCAxIDEzMTA3MiAyMSA4IC0wLjc1ODQNCiAiQyIgIkMiIDAgMSAxMzEwNzIgMjIgNiAwLjU5NzMNCiAiTyIgIk8iIDAgMSAxMzEwNzIgMjMgOCAtMC41Njc5DQohZW50cnkuS0NYLnVuaXQuYXRvbXNwZXJ0aW5mbyB0YWJsZSBzdHIgcG5hbWUgc3RyIHB0eXBlIGludCBwdHlwZXggaW50IHBlbG1udCBkYmwgcGNoZw0KICJOIiAiTiIgMCAtMSAwLjANCiAiSCIgIkgiIDAgLTEgMC4wDQogIkNBIiAiQ1giIDAgLTEgMC4wDQogIkhBIiAiSDEiIDAgLTEgMC4wDQogIkNCIiAiQzMiIDAgLTEgMC4wDQogIkhCMiIgIkhDIiAwIC0xIDAuMA0KICJIQjMiICJIQyIgMCAtMSAwLjANCiAiQ0ciICJDMyIgMCAtMSAwLjANCiAiSEcyIiAiSEMiIDAgLTEgMC4wDQogIkhHMyIgIkhDIiAwIC0xIDAuMA0KICJDRCIgIkMzIiAwIC0xIDAuMA0KICJIRDIiICJIQyIgMCAtMSAwLjANCiAiSEQzIiAiSEMiIDAgLTEgMC4wDQogIkNFIiAiQzMiIDAgLTEgMC4wDQogIkhFMiIgIkhQIiAwIC0xIDAuMA0KICJIRTMiICJIUCIgMCAtMSAwLjANCiAiTloiICJOIiAwIC0xIDAuMA0KICJIWiIgIkgiIDAgLTEgMC4wDQogIkNZIiAiQ1kiIDAgLTEgMC4wDQogIk9RMSIgIk8yIiAwIC0xIDAuMA0KICJPUTIiICJPMiIgMCAtMSAwLjANCiAiQyIgIkMiIDAgLTEgMC4wDQogIk8iICJPIiAwIC0xIDAuMA0KIWVudHJ5LktDWC51bml0LmJvdW5kYm94IGFycmF5IGRibA0KIC0xLjAwMDAwMA0KIDAuMA0KIDAuMA0KIDAuMA0KIDAuMA0KIWVudHJ5LktDWC51bml0LmNoaWxkc2VxdWVuY2Ugc2luZ2xlIGludA0KIDINCiFlbnRyeS5LQ1gudW5pdC5jb25uZWN0IGFycmF5IGludA0KIDENCiAyMg0KIWVudHJ5LktDWC51bml0LmNvbm5lY3Rpdml0eSB0YWJsZSBpbnQgYXRvbTF4IGludCBhdG9tMnggaW50IGZsYWdzDQogMSAyIDENCiAxIDMgMQ0KIDMgNCAxDQogMyA1IDENCiAzIDIyIDENCiA1IDYgMQ0KIDUgNyAxDQogNSA4IDENCiA4IDkgMQ0KIDggMTAgMQ0KIDggMTEgMQ0KIDExIDEyIDENCiAxMSAxMyAxDQogMTEgMTQgMQ0KIDE0IDE1IDENCiAxNCAxNiAxDQogMTQgMTcgMQ0KIDE3IDE4IDENCiAxNyAxOSAxDQogMTkgMjAgMQ0KIDE5IDIxIDENCiAyMiAyMyAyDQohZW50cnkuS0NYLnVuaXQuaGllcmFyY2h5IHRhYmxlIHN0ciBhYmVzc2lvbiBpbnQgZXNzaW9uIHN0ciBiZXNzaW9uIGludCBjZXNzaW9uDQogIlUiIDAgIlIiIDENCiAiUiIgMSAiQSIgMQ0KICJSIiAxICJBIiAyDQogIlIiIDEgIkEiIDMNCiAiUiIgMSAiQSIgNA0KICJSIiAxICJBIiA1DQogIlIiIDEgIkEiIDYNCiAiUiIgMSAiQSIgNw0KICJSIiAxICJBIiA4DQogIlIiIDEgIkEiIDkNCiAiUiIgMSAiQSIgMTANCiAiUiIgMSAiQSIgMTENCiAiUiIgMSAiQSIgMTINCiAiUiIgMSAiQSIgMTMNCiAiUiIgMSAiQSIgMTQNCiAiUiIgMSAiQSIgMTUNCiAiUiIgMSAiQSIgMTYNCiAiUiIgMSAiQSIgMTcNCiAiUiIgMSAiQSIgMTgNCiAiUiIgMSAiQSIgMTkNCiAiUiIgMSAiQSIgMjANCiAiUiIgMSAiQSIgMjENCiAiUiIgMSAiQSIgMjINCiAiUiIgMSAiQSIgMjMNCiFlbnRyeS5LQ1gudW5pdC5uYW1lIHNpbmdsZSBzdHINCiAiS0NYIg0KIWVudHJ5LktDWC51bml0LnBvc2l0aW9ucyB0YWJsZSBkYmwgeCBkYmwgeSBkYmwgeg0KIDMuMzI1NzcwIDEuNTQ3OTA5IC0wLjAwMDAwMg0KIDMuOTA5NDA3IDAuNzIzNjExIC0wLjAwMDAwOA0KIDEuOTQ1OTE2IDEuMjc3MTU1IDAuMDAwMDI4DQogMS43NjgxNjMgMC4yMDEwODggMC4wMDAwNTENCiAxLjE0NDI3NyAxLjkzMTAzOCAxLjE0ODg1MQ0KIDEuMjg2NTY2IDMuMDEyNjYwIDEuMTE3NTEzDQogMS41MzcwMjggMS41NTA0OTUgMi4wOTY0MjQNCiAtMC4zNTYwOTAgMS42MjE2NjQgMS4wODg4MjENCiAtMC41NTU5MzQgMC41NDk1NDEgMS4xMTkyNzYNCiAtMC43NDk2NDkgMi4wMzA4ODAgMi4wMjcxMTQNCiAtMS4wNjQwNDQgMi4yNjg4MjUgLTAuMTA4Njk5DQogLTAuODUxNDAxIDMuMzQxMDQxIC0wLjEzODYzMg0KIC0wLjY2OTY0OCAxLjg0NjY1NCAtMS4wMzk1MDUNCiAtMi41Njk5MzMgMi4wNDAxNjUgLTAuMDY5ODE2DQogLTIuNzcxNzA2IDAuOTY3MDAzIC0wLjA1MTI4OQ0KIC0yLjk3OTA3NiAyLjQ3OTA5OCAwLjg0NjA1Mg0KIC0zLjI1MzIzNiAyLjY2MDI4NSAtMS4yMDEwNTINCiAtMi45Mzk5MjAgMi4zMDAyMTAgLTIuMDk1MDMxDQogLTQuNjM4MTE4IDIuNDQ5NzMwIC0xLjI1NDU4Mw0KIC01LjA0MDEzMCAxLjg1ODIzMCAtMi4yNDQwNTANCiAtNS4yODUwNTAgMi44ODc2MjAgLTAuMzI2NjkwDQogMS4xNDQyNzkgMS45MzEwNDIgLTEuMTQ4NzgzDQogMC41MjQ5NDUgMS40NTg0MTMgLTIuMDg2NjU3DQohZW50cnkuS0NYLnVuaXQucmVzaWR1ZWNvbm5lY3QgdGFibGUgaW50IGMxeCBpbnQgYzJ4IGludCBjM3ggaW50IGM0eCBpbnQgYzV4IGludCBjNngNCiAxIDIyIDAgMCAwIDANCiFlbnRyeS5LQ1gudW5pdC5yZXNpZHVlcyB0YWJsZSBzdHIgbmFtZSBpbnQgc2VxIGludCBjaGlsZHNlcSBpbnQgc3RhcnRhdG9teCBzdHIgcmVzdHlwZSBpbnQgaW1hZ2Vzc2lvbg0KICJLQ1giIDEgMjQgMSAiPyIgMA0KIWVudHJ5LktDWC51bml0LnJlc2lkdWVzUGRiU2VxdWVuY2VOdW1iZXIgYXJyYXkgaW50DQogMA0KIWVudHJ5LktDWC51bml0LnNvbHZlbnRjYXAgYXJyYXkgZGJsDQogLTEuMDAwMDAwDQogMC4wDQogMC4wDQogMC4wDQogMC4wDQohZW50cnkuS0NYLnVuaXQudmVsb2NpdGllcyB0YWJsZSBkYmwgeCBkYmwgeSBkYmwgeg0KIDAuMCAwLjAgMC4wDQogMC4wIDAuMCAwLjANCiAwLjAgMC4wIDAuMA0KIDAuMCAwLjAgMC4wDQogMC4wIDAuMCAwLjANCiAwLjAgMC4wIDAuMA0KIDAuMCAwLjAgMC4wDQogMC4wIDAuMCAwLjANCiAwLjAgMC4wIDAuMA0KIDAuMCAwLjAgMC4wDQogMC4wIDAuMCAwLjANCiAwLjAgMC4wIDAuMA0KIDAuMCAwLjAgMC4wDQogMC4wIDAuMCAwLjANCiAwLjAgMC4wIDAuMA0KIDAuMCAwLjAgMC4wDQogMC4wIDAuMCAwLjANCiAwLjAgMC4wIDAuMA0KIDAuMCAwLjAgMC4wDQogMC4wIDAuMCAwLjANCiAwLjAgMC4wIDAuMA0KIDAuMCAwLjAgMC4wDQogMC4wIDAuMCAwLjA=" | base64 -d > /app/kcx_params/kcx.lib

# kcx.frcmod
RUN echo "S0NYIChONi1jYXJib3h5bHlzaW5lKSBmb3JjZSBmaWVsZCBwYXJhbWV0ZXJzIGZvciBBTUJFUiBmZjE5U0INCkRlcml2ZWQgZnJvbSBseXNpbmUgcGFyYW1ldGVycyB3aXRoIGNhcmJhbWF0ZSBtb2RpZmljYXRpb25zDQpSZWZlcmVuY2U6IERPSSAxMC4xMDAyL2pjYy4yMTgzNg0KDQpNQVNTDQpDWSAxMi4wMSAgICAgICAgIDAuMzYwICAgICAgICAgICAgIHNwMiBjYXJib3h5bCBjYXJib24gb2YgY2FyYmFtYXRlDQoNCkJPTkQNCkNZLU8yICAgNjQ4LjAgICAgMS4yNTAgICAgICAgY2FyYm94eWxhdGUgQy1PIChzYW1lIGFzIENPTy0pDQpDWS1OICAgIDM2Ny4wICAgIDEuMzgwICAgICAgIGNhcmJhbWF0ZSBDLU4gYm9uZA0KTi1IICAgICA0MzQuMCAgICAxLjAxMCAgICAgICBOLUggaW4gY2FyYmFtYXRlDQpDMy1OICAgIDMzNy4wICAgIDEuNDc1ICAgICAgIENFLU5aIGJvbmQNCg0KQU5HTEUNCk8yLUNZLU8yICAgIDgwLjAgICAgICAxMjYuMCAgICAgIGNhcmJveHlsYXRlIE8tQy1PDQpPMi1DWS1OICAgICA3MC4wICAgICAgMTE3LjAgICAgICBjYXJiYW1hdGUgTy1DLU4NCkNZLU4tQzMgICAgIDgwLjAgICAgICAxMjIuMCAgICAgIGNhcmJhbWF0ZSBDLU4tQ0UgYW5nbGUNCkNZLU4tSCAgICAgIDUwLjAgICAgICAxMTguMCAgICAgIGNhcmJhbWF0ZSBDLU4tSCBhbmdsZQ0KQzMtTi1IICAgICAgNTAuMCAgICAgIDExOC4wICAgICAgQ0UtTi1IIGFuZ2xlDQpILU4tSCAgICAgICAzNS4wICAgICAgMTIwLjAgICAgICBILU4tSA0KDQpESUhFDQpPMi1DWS1OLUMzICAgIDIgICAgMi41ICAgICAxODAuMCAgICAgMi4gICAgICBjYXJiYW1hdGUgcm90YXRpb24gYmFycmllcg0KTzItQ1ktTi1IICAgICAyICAgIDIuNSAgICAgMTgwLjAgICAgIDIuDQpDMy1DMy1OLUNZICAgIDEgICAgMC4wICAgICAgIDAuMCAgICAgMy4gICAgICBDRC1DRS1OWi1DWSB0b3JzaW9uDQpDMy1DMy1OLUggICAgIDEgICAgMC4wICAgICAgIDAuMCAgICAgMy4NClggLUNZLU4tWCAgICAgMiAgICAyLjUgICAgIDE4MC4wICAgICAyLiAgICAgIGdlbmVyaWMgY2FyYmFtYXRlDQoNCklNUFJPUEVSDQpDWS1OLU8yLU8yICAgMTAuNSAgICAxODAuMCAgICAgMi4gICAgICBjYXJib3h5bGF0ZSBwbGFuYXJpdHkNCk4tQzMtQ1ktSCAgICAgMS4wICAgIDE4MC4wICAgICAyLiAgICAgIG5pdHJvZ2VuIHBsYW5hcml0eQ0KDQpOT05CT04NCiAgQ1kgICAgICAgICAgMS45MDgwICAwLjA4NjAgICAgICAgICAgICAgc2FtZSBhcyBzcDIgQw==" | base64 -d > /app/kcx_params/kcx.frcmod

# entrypoint.py
RUN echo "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uDQoiIiINCk9wZW5NTSBNRCBTaW11bGF0aW9uIHdpdGggS0NYIFN1cHBvcnQNCk9wdGltaXplZCBmb3IgTlZJRElBIEExMDAgb24gVGFtYXJpbmQgUGxhdGZvcm0NCiIiIg0KDQppbXBvcnQgb3MNCmltcG9ydCBzeXMNCmltcG9ydCBzdWJwcm9jZXNzDQppbXBvcnQgc2h1dGlsDQppbXBvcnQgdHJhY2ViYWNrDQoNCmltcG9ydCBtYXRwbG90bGliDQptYXRwbG90bGliLnVzZSgnQWdnJykNCg0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KIyBUQU1BUklORCBQQVRIIENPTkZJR1VSQVRJT04NCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NClBEQl9GSUxFX0lOUFVUID0gImlucHV0cy9wZGJGaWxlLnBkYiINCkxJR0FORF9GSUxFX0lOUFVUID0gImlucHV0cy9saWdhbmRGaWxlLnNkZiINCk9VVFBVVF9ESVIgPSAib3V0Ig0KUFJFUF9ESVIgPSBvcy5wYXRoLmpvaW4oT1VUUFVUX0RJUiwgInByZXAiKQ0KUEFSQU1TX0RJUiA9IG9zLnBhdGguam9pbihPVVRQVVRfRElSLCAicGFyYW1zIikNCktDWF9QQVJBTVNfRElSID0gIi9hcHAva2N4X3BhcmFtcyINCg0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KIyBQQVJBTUVURVJTIEZST00gRU5WSVJPTk1FTlQgVkFSSUFCTEVTDQojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQpqb2JfbmFtZSA9IG9zLmdldGVudignSm9iTmFtZScsICdvcGVubW1fc2ltdWxhdGlvbicpDQpsaWdhbmRfY2hhcmdlID0gaW50KG9zLmdldGVudignbGlnYW5kQ2hhcmdlJywgJzAnKSkNCmZvcmNlX2ZpZWxkID0gb3MuZ2V0ZW52KCdmb3JjZUZpZWxkJywgJ2ZmMTlzYicpLmxvd2VyKCkNCndhdGVyX21vZGVsID0gb3MuZ2V0ZW52KCd3YXRlck1vZGVsJywgJ3RpcDNwJykubG93ZXIoKQ0KYm94X3NpemUgPSBmbG9hdChvcy5nZXRlbnYoJ2JveFNpemUnLCAnMTIuMCcpKQ0KaW9uaWNfc3RyZW5ndGggPSBmbG9hdChvcy5nZXRlbnYoJ2lvbmljU3RyZW5ndGgnLCAnMC4xNScpKQ0KbWluaW1pemF0aW9uX3N0ZXBzID0gaW50KG9zLmdldGVudignbWluaW1pemF0aW9uU3RlcHMnLCAnMTAwMDAnKSkNCmVxdWlsaWJyYXRpb25fdGltZSA9IGZsb2F0KG9zLmdldGVudignZXF1aWxpYnJhdGlvblRpbWUnLCAnMC4yJykpDQpwcm9kdWN0aW9uX3RpbWUgPSBmbG9hdChvcy5nZXRlbnYoJ3Byb2R1Y3Rpb25UaW1lJywgJzEuMCcpKQ0KdGltZXN0ZXAgPSBmbG9hdChvcy5nZXRlbnYoJ3RpbWVzdGVwJywgJzIuMCcpKQ0KdGVtcGVyYXR1cmUgPSBmbG9hdChvcy5nZXRlbnYoJ3RlbXBlcmF0dXJlJywgJzMxMC4wJykpDQpwcmVzc3VyZSA9IGZsb2F0KG9zLmdldGVudigncHJlc3N1cmUnLCAnMS4wJykpDQpwSCA9IGZsb2F0KG9zLmdldGVudigncEgnLCAnNy4wJykpDQpjb25zdHJhaW50cyA9IG9zLmdldGVudignY29uc3RyYWludHMnLCAnSEJvbmRzJykNCnByb2RfdHJhal9mcmVxID0gaW50KG9zLmdldGVudigncHJvZFRyYWpGcmVxJywgJzUwMDAnKSkNCnN0ZXBfc2l6ZSA9IGludChvcy5nZXRlbnYoJ3N0ZXBTaXplJywgJzUnKSkNCmN1ZGFfcHJlY2lzaW9uID0gb3MuZ2V0ZW52KCdDVURBX1BSRUNJU0lPTicsICdtaXhlZCcpDQpkZWZhdWx0X3BsYXRmb3JtID0gb3MuZ2V0ZW52KCdPUEVOTU1fREVGQVVMVF9QTEFURk9STScsICdDVURBJykNCg0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KIyBVVElMSVRZIEZVTkNUSU9OUw0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQpkZWYgcnVuX2NvbW1hbmQoY21kLCBkZXNjcmlwdGlvbik6DQogICAgIiIiUnVuIHN1YnByb2Nlc3MgY29tbWFuZCB3aXRoIGVycm9yIGhhbmRsaW5nIiIiDQogICAgcHJpbnQoZiItLT4gUnVubmluZzoge2Rlc2NyaXB0aW9ufSIpDQogICAgcHJpbnQoZiIgICAgQ29tbWFuZDogeycgJy5qb2luKGNtZCl9IikNCiAgICBwcm9jZXNzID0gc3VicHJvY2Vzcy5Qb3BlbigNCiAgICAgICAgY21kLCBzdGRvdXQ9c3VicHJvY2Vzcy5QSVBFLCBzdGRlcnI9c3VicHJvY2Vzcy5QSVBFLCB0ZXh0PVRydWUNCiAgICApDQogICAgc3Rkb3V0LCBzdGRlcnIgPSBwcm9jZXNzLmNvbW11bmljYXRlKCkNCiAgICANCiAgICBpZiBwcm9jZXNzLnJldHVybmNvZGUgIT0gMDoNCiAgICAgICAgcHJpbnQoZiJFUlJPUiBpbiB7ZGVzY3JpcHRpb259OiIpDQogICAgICAgIHByaW50KGYiU1RET1VUOiB7c3Rkb3V0fSIpDQogICAgICAgIHByaW50KGYiU1RERVJSOiB7c3RkZXJyfSIpDQogICAgICAgIHN5cy5leGl0KDEpDQogICAgZWxzZTogDQogICAgICAgIGlmIHN0ZG91dC5zdHJpcCgpOg0KICAgICAgICAgICAgcHJpbnQoZiIgICAgT3V0cHV0OiB7c3Rkb3V0LnN0cmlwKClbOjIwMF19IikNCiAgICByZXR1cm4gcHJvY2Vzcw0KDQpkZWYgcHJpbnRfZ3B1X2luZm8oKToNCiAgICAiIiJQcmludCBHUFUgaW5mb3JtYXRpb24gZm9yIGRlYnVnZ2luZyIiIg0KICAgIHByaW50KCJcbi0tPiBHUFUgRW52aXJvbm1lbnQgQ29uZmlndXJhdGlvbjoiKQ0KICAgIGdwdV92YXJzID0gWw0KICAgICAgICAnTlZJRElBX1ZJU0lCTEVfREVWSUNFUycsICdDVURBX1ZJU0lCTEVfREVWSUNFUycsDQogICAgICAgICdPUEVOTU1fREVGQVVMVF9QTEFURk9STScsICdDVURBX0NBQ0hFX0RJU0FCTEUnLA0KICAgICAgICAnQ1VEQV9NUFNfUElQRV9ESVJFQ1RPUlknDQogICAgXQ0KICAgIGZvciB2YXIgaW4gZ3B1X3ZhcnM6DQogICAgICAgIHZhbHVlID0gb3MuZ2V0ZW52KHZhciwgJ25vdCBzZXQnKQ0KICAgICAgICBwcmludChmIiAgICB7dmFyfToge3ZhbHVlfSIpDQoNCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiMgS0NYICYgU1lTVEVNIFBSRVAgVVRJTElUSUVTDQojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQoNCmRlZiBnZXRfa2N4X3BhcmFtZXRlcnMoKToNCiAgICAiIiJVc2UgcHJlLWJ1bmRsZWQgS0NYIHBhcmFtZXRlcnMgZnJvbSBEb2NrZXIgaW1hZ2UiIiINCiAgICBmcmNtb2RfcGF0aCA9IG9zLnBhdGguam9pbihLQ1hfUEFSQU1TX0RJUiwgJ2tjeC5mcmNtb2QnKQ0KICAgIGxpYl9wYXRoID0gb3MucGF0aC5qb2luKEtDWF9QQVJBTVNfRElSLCAna2N4LmxpYicpDQogICAgDQogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZyY21vZF9wYXRoKToNCiAgICAgICAgcHJpbnQoZiJXQVJOSU5HOiBLQ1ggZnJjbW9kIG5vdCBmb3VuZCBhdCB7ZnJjbW9kX3BhdGh9IikNCiAgICAgICAgcHJpbnQoIiAgICBDb250aW51aW5nIHdpdGhvdXQgS0NYIHBhcmFtZXRlcnMgKHByb3RlaW4tb25seSBtb2RlKSIpDQogICAgICAgIHJldHVybiBOb25lLCBOb25lDQogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGxpYl9wYXRoKToNCiAgICAgICAgcHJpbnQoZiJXQVJOSU5HOiBLQ1ggbGliIG5vdCBmb3VuZCBhdCB7bGliX3BhdGh9IikNCiAgICAgICAgcHJpbnQoIiAgICBDb250aW51aW5nIHdpdGhvdXQgS0NYIHBhcmFtZXRlcnMgKHByb3RlaW4tb25seSBtb2RlKSIpDQogICAgICAgIHJldHVybiBOb25lLCBOb25lDQogICAgDQogICAgcHJpbnQoZiItLT4gVXNpbmcgS0NYIHBhcmFtZXRlcnMgZnJvbSB7S0NYX1BBUkFNU19ESVJ9IikNCiAgICByZXR1cm4gZnJjbW9kX3BhdGgsIGxpYl9wYXRoDQoNCmRlZiB2YWxpZGF0ZV9rY3hfcmVzaWR1ZXMocGRiX3BhdGgpOg0KICAgICIiIg0KICAgIFZhbGlkYXRlIEtDWCAoY2FyYm94eWxhdGVkIGx5c2luZSkgcmVzaWR1ZXMgaW4gUERCIGZpbGUuDQogICAgDQogICAgQ2hlY2tzOg0KICAgIDEuIFByZXNlbmNlIG9mIEtDWCByZXNpZHVlcw0KICAgIDIuIFJlcXVpcmVkIGNhcmJhbWF0ZSBhdG9tcyAoTlosIEhaLCBDWSwgT1ExLCBPUTIpDQogICAgMy4gQmFzaWMgZ2VvbWV0cnkgdmFsaWRhdGlvbg0KICAgIDQuIHBILWRlcGVuZGVudCB3YXJuaW5ncw0KICAgIA0KICAgIFJldHVybnM6DQogICAgICAgIGRpY3Q6IFZhbGlkYXRpb24gcmVzdWx0cyB3aXRoIEtDWCBpbmZvDQogICAgIiIiDQogICAgcHJpbnQoZiItLT4gVmFsaWRhdGluZyBLQ1ggcmVzaWR1ZXMgaW4ge3BkYl9wYXRofSIpDQogICAgDQogICAgIyBFeHBlY3RlZCBjYXJiYW1hdGUgYXRvbXMgaW4gS0NYIChmcm9tIGtjeC5saWIpDQogICAgUkVRVUlSRURfQ0FSQkFNQVRFX0FUT01TID0geydOWicsICdDWScsICdPUTEnLCAnT1EyJ30gICMgSFogbWF5IGJlIG1pc3NpbmcgaW4gc29tZSBQREJzDQogICAgT1BUSU9OQUxfQVRPTVMgPSB7J0haJ30gICMgSHlkcm9nZW4gbWF5IG5vdCBiZSBpbiBjcnlzdGFsIHN0cnVjdHVyZXMNCiAgICANCiAgICAjIFBhcnNlIFBEQiBhbmQgY29sbGVjdCBLQ1ggcmVzaWR1ZXMNCiAgICBrY3hfcmVzaWR1ZXMgPSB7fSAgIyB7KGNoYWluLCByZXNudW0pOiB7YXRvbV9uYW1lOiAoeCwgeSwgeil9fQ0KICAgIA0KICAgIHdpdGggb3BlbihwZGJfcGF0aCwgJ3InKSBhcyBmOg0KICAgICAgICBmb3IgbGluZSBpbiBmOg0KICAgICAgICAgICAgaWYgbGluZS5zdGFydHN3aXRoKCgnQVRPTScsICdIRVRBVE0nKSk6DQogICAgICAgICAgICAgICAgcmVzX25hbWUgPSBsaW5lWzE3OjIwXS5zdHJpcCgpDQogICAgICAgICAgICAgICAgaWYgcmVzX25hbWUgPT0gJ0tDWCc6DQogICAgICAgICAgICAgICAgICAgIGNoYWluID0gbGluZVsyMV0uc3RyaXAoKSBvciAnQScNCiAgICAgICAgICAgICAgICAgICAgcmVzX251bSA9IGludChsaW5lWzIyOjI2XS5zdHJpcCgpKQ0KICAgICAgICAgICAgICAgICAgICBhdG9tX25hbWUgPSBsaW5lWzEyOjE2XS5zdHJpcCgpDQogICAgICAgICAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICAgICAgICAgIHggPSBmbG9hdChsaW5lWzMwOjM4XSkNCiAgICAgICAgICAgICAgICAgICAgICAgIHkgPSBmbG9hdChsaW5lWzM4OjQ2XSkNCiAgICAgICAgICAgICAgICAgICAgICAgIHogPSBmbG9hdChsaW5lWzQ2OjU0XSkNCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6DQogICAgICAgICAgICAgICAgICAgICAgICB4LCB5LCB6ID0gMC4wLCAwLjAsIDAuMA0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAga2V5ID0gKGNoYWluLCByZXNfbnVtKQ0KICAgICAgICAgICAgICAgICAgICBpZiBrZXkgbm90IGluIGtjeF9yZXNpZHVlczoNCiAgICAgICAgICAgICAgICAgICAgICAgIGtjeF9yZXNpZHVlc1trZXldID0ge30NCiAgICAgICAgICAgICAgICAgICAga2N4X3Jlc2lkdWVzW2tleV1bYXRvbV9uYW1lXSA9ICh4LCB5LCB6KQ0KICAgIA0KICAgICMgUmVwb3J0IGZpbmRpbmdzDQogICAgcmVzdWx0cyA9IHsNCiAgICAgICAgJ2ZvdW5kJzogbGVuKGtjeF9yZXNpZHVlcykgPiAwLA0KICAgICAgICAnY291bnQnOiBsZW4oa2N4X3Jlc2lkdWVzKSwNCiAgICAgICAgJ3Jlc2lkdWVzJzogW10sDQogICAgICAgICd3YXJuaW5ncyc6IFtdLA0KICAgICAgICAnZXJyb3JzJzogW10NCiAgICB9DQogICAgDQogICAgaWYgbm90IGtjeF9yZXNpZHVlczoNCiAgICAgICAgcHJpbnQoIiAgICBObyBLQ1ggcmVzaWR1ZXMgZm91bmQgaW4gUERCIikNCiAgICAgICAgcHJpbnQoIiAgICBOT1RFOiBJZiB5b3VyIHByb3RlaW4gaGFzIGNhcmJveHlsYXRlZCBseXNpbmUsIGVuc3VyZSBpdCdzIGxhYmVsZWQgYXMgJ0tDWCciKQ0KICAgICAgICBwcmludCgiICAgICAgICAgIEFscGhhRm9sZCBzdHJ1Y3R1cmVzIG1heSBsYWJlbCBLQ1ggYXMgJ0xZUycgLSBtYW51YWwgZWRpdGluZyByZXF1aXJlZCIpDQogICAgICAgIHJlc3VsdHNbJ3dhcm5pbmdzJ10uYXBwZW5kKCJObyBLQ1ggcmVzaWR1ZXMgZm91bmQgLSBjaGVjayBpZiBseXNpbmVzIHNob3VsZCBiZSBjYXJib3h5bGF0ZWQiKQ0KICAgICAgICByZXR1cm4gcmVzdWx0cw0KICAgIA0KICAgIHByaW50KGYiICAgIEZvdW5kIHtsZW4oa2N4X3Jlc2lkdWVzKX0gS0NYIHJlc2lkdWUocykiKQ0KICAgIA0KICAgIGZvciAoY2hhaW4sIHJlc19udW0pLCBhdG9tcyBpbiBrY3hfcmVzaWR1ZXMuaXRlbXMoKToNCiAgICAgICAgcmVzX2lkID0gZiJLQ1gte2NoYWlufXtyZXNfbnVtfSINCiAgICAgICAgYXRvbV9uYW1lcyA9IHNldChhdG9tcy5rZXlzKCkpDQogICAgICAgIA0KICAgICAgICAjIENoZWNrIGZvciByZXF1aXJlZCBjYXJiYW1hdGUgYXRvbXMNCiAgICAgICAgbWlzc2luZ19yZXF1aXJlZCA9IFJFUVVJUkVEX0NBUkJBTUFURV9BVE9NUyAtIGF0b21fbmFtZXMNCiAgICAgICAgbWlzc2luZ19vcHRpb25hbCA9IE9QVElPTkFMX0FUT01TIC0gYXRvbV9uYW1lcw0KICAgICAgICANCiAgICAgICAgcmVzX2luZm8gPSB7DQogICAgICAgICAgICAnY2hhaW4nOiBjaGFpbiwNCiAgICAgICAgICAgICdyZXNudW0nOiByZXNfbnVtLA0KICAgICAgICAgICAgJ2F0b21zJzogbGlzdChhdG9tX25hbWVzKSwNCiAgICAgICAgICAgICd2YWxpZCc6IFRydWUNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYgbWlzc2luZ19yZXF1aXJlZDoNCiAgICAgICAgICAgIHByaW50KGYiICAgIOKclyB7cmVzX2lkfTogTUlTU0lORyBjYXJiYW1hdGUgYXRvbXM6IHttaXNzaW5nX3JlcXVpcmVkfSIpDQogICAgICAgICAgICBwcmludChmIiAgICAgIFRoaXMgS0NYIG1heSBub3QgYmUgcGFyYW1ldGVyaXplZCBjb3JyZWN0bHkhIikNCiAgICAgICAgICAgIHJlc3VsdHNbJ2Vycm9ycyddLmFwcGVuZChmIntyZXNfaWR9IG1pc3NpbmcgYXRvbXM6IHttaXNzaW5nX3JlcXVpcmVkfSIpDQogICAgICAgICAgICByZXNfaW5mb1sndmFsaWQnXSA9IEZhbHNlDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBwcmludChmIiAgICDinJMge3Jlc19pZH06IEFsbCBjYXJiYW1hdGUgYXRvbXMgcHJlc2VudCIpDQogICAgICAgICAgICANCiAgICAgICAgICAgICMgR2VvbWV0cnkgY2hlY2sgLSBDWS1PUSBib25kIGxlbmd0aCBzaG91bGQgYmUgfjEuMjUgw4UNCiAgICAgICAgICAgIGlmICdDWScgaW4gYXRvbXMgYW5kICdPUTEnIGluIGF0b21zOg0KICAgICAgICAgICAgICAgIGN5ID0gYXRvbXNbJ0NZJ10NCiAgICAgICAgICAgICAgICBvcTEgPSBhdG9tc1snT1ExJ10NCiAgICAgICAgICAgICAgICBkaXN0ID0gKChjeVswXS1vcTFbMF0pKioyICsgKGN5WzFdLW9xMVsxXSkqKjIgKyAoY3lbMl0tb3ExWzJdKSoqMikgKiogMC41DQogICAgICAgICAgICAgICAgaWYgMS4xNSA8PSBkaXN0IDw9IDEuMzU6DQogICAgICAgICAgICAgICAgICAgIHByaW50KGYiICAgICAg4pyTIENZLU9RMSBib25kIGxlbmd0aDoge2Rpc3Q6LjJmfSDDhSAoZXhwZWN0ZWQgfjEuMjUgw4UpIikNCiAgICAgICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgICAgICBwcmludChmIiAgICAgIOKaoCBDWS1PUTEgYm9uZCBsZW5ndGg6IHtkaXN0Oi4yZn0gw4UgKGV4cGVjdGVkIH4xLjI1IMOFKSAtIHVudXN1YWwhIikNCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1snd2FybmluZ3MnXS5hcHBlbmQoZiJ7cmVzX2lkfSB1bnVzdWFsIENZLU9RMSBkaXN0YW5jZToge2Rpc3Q6LjJmfSDDhSIpDQogICAgICAgIA0KICAgICAgICBpZiBtaXNzaW5nX29wdGlvbmFsOg0KICAgICAgICAgICAgcHJpbnQoZiIgICAgICBOb3RlOiBNaXNzaW5nIG9wdGlvbmFsIGF0b21zIHttaXNzaW5nX29wdGlvbmFsfSAod2lsbCBiZSBhZGRlZCBieSByZWR1Y2UpIikNCiAgICAgICAgDQogICAgICAgIHJlc3VsdHNbJ3Jlc2lkdWVzJ10uYXBwZW5kKHJlc19pbmZvKQ0KICAgIA0KICAgICMgcEgtc3BlY2lmaWMgd2FybmluZ3MgZm9yIEtDWA0KICAgIGlmIHBIIDwgNi4wOg0KICAgICAgICBwcmludChmIiAgICDimqAgV0FSTklORzogcEgge3BIfSBpcyBuZWFyL2JlbG93IEtDWCBjYXJiYW1hdGUgcEthICh+NS41KSIpDQogICAgICAgIHByaW50KGYiICAgICAgVGhlIGNhcmJhbWF0ZSBncm91cCBtYXkgYmUgcGFydGlhbGx5IHByb3RvbmF0ZWQgYXQgdGhpcyBwSCIpDQogICAgICAgIHByaW50KGYiICAgICAgQ3VycmVudCBwYXJhbWV0ZXJzIGFzc3VtZSBkZXByb3RvbmF0ZWQgKGNoYXJnZWQpIGNhcmJhbWF0ZSIpDQogICAgICAgIHJlc3VsdHNbJ3dhcm5pbmdzJ10uYXBwZW5kKGYicEgge3BIfSBtYXkgYWZmZWN0IEtDWCBwcm90b25hdGlvbiBzdGF0ZSIpDQogICAgDQogICAgIyBTdW1tYXJ5DQogICAgdmFsaWRfY291bnQgPSBzdW0oMSBmb3IgciBpbiByZXN1bHRzWydyZXNpZHVlcyddIGlmIHJbJ3ZhbGlkJ10pDQogICAgcHJpbnQoZiIgICAgU3VtbWFyeToge3ZhbGlkX2NvdW50fS97bGVuKGtjeF9yZXNpZHVlcyl9IEtDWCByZXNpZHVlcyB2YWxpZGF0ZWQgc3VjY2Vzc2Z1bGx5IikNCiAgICANCiAgICBpZiByZXN1bHRzWydlcnJvcnMnXToNCiAgICAgICAgcHJpbnQoZiIgICAg4pqgIHtsZW4ocmVzdWx0c1snZXJyb3JzJ10pfSBlcnJvcihzKSBmb3VuZCAtIHNpbXVsYXRpb24gbWF5IGZhaWwhIikNCiAgICANCiAgICByZXR1cm4gcmVzdWx0cw0KDQpkZWYgcHJlcGFyZV9saWdhbmQobGlnX2ZpbGUsIGxpZ19jaGFyZ2UsIG91dHB1dF9kaXIpOg0KICAgICIiIlByZXBhcmUgbGlnYW5kIHdpdGggQW50ZWNoYW1iZXIgYW5kIEdBRkYyIiIiDQogICAgcHJpbnQoZiItLT4gUHJlcGFyaW5nIExpZ2FuZDoge2xpZ19maWxlfSIpDQogICAgb3MubWFrZWRpcnMob3V0cHV0X2RpciwgZXhpc3Rfb2s9VHJ1ZSkNCiAgICBtb2wyX291dCA9IG9zLnBhdGguam9pbihvdXRwdXRfZGlyLCAnbGlnYW5kLm1vbDInKQ0KICAgIGZyY21vZF9vdXQgPSBvcy5wYXRoLmpvaW4ob3V0cHV0X2RpciwgJ2xpZ2FuZC5mcmNtb2QnKQ0KICAgIA0KICAgIGNtZCA9IFsNCiAgICAgICAgJ2FudGVjaGFtYmVyJywgJy1pJywgbGlnX2ZpbGUsICctZmknLCAnc2RmJywNCiAgICAgICAgJy1vJywgbW9sMl9vdXQsICctZm8nLCAnbW9sMicsDQogICAgICAgICctYycsICdiY2MnLCAnLWF0JywgJ2dhZmYyJywNCiAgICAgICAgJy1uYycsIHN0cihsaWdfY2hhcmdlKSwgJy1wZicsICd5Jw0KICAgIF0NCiAgICBydW5fY29tbWFuZChjbWQsICJBbnRlY2hhbWJlciIpDQogICAgDQogICAgY21kID0gWydwYXJtY2hrMicsICctaScsIG1vbDJfb3V0LCAnLWYnLCAnbW9sMicsICctbycsIGZyY21vZF9vdXQsICctcycsICdnYWZmMiddDQogICAgcnVuX2NvbW1hbmQoY21kLCAiUGFybWNoazIiKQ0KICAgIA0KICAgIHByaW50KGYiLS0+IExpZ2FuZCBwcmVwYXJlZDoge21vbDJfb3V0fSIpDQogICAgcmV0dXJuIG1vbDJfb3V0LCBmcmNtb2Rfb3V0DQoNCmRlZiBwcmVwYXJlX3Byb3RlaW4ocGRiX3BhdGgsIG91dHB1dF9kaXIpOg0KICAgICIiIlByZXBhcmUgcHJvdGVpbiBzdHJ1Y3R1cmUgd2l0aCBwZGI0YW1iZXIgYW5kIHBILWRlcGVuZGVudCBwcm90b25hdGlvbiIiIg0KICAgIHByaW50KGYiLS0+IFByZXBhcmluZyBQcm90ZWluOiB7cGRiX3BhdGh9IikNCiAgICBwcmludChmIiAgICBUYXJnZXQgcEg6IHtwSH0iKQ0KICAgIG9zLm1ha2VkaXJzKG91dHB1dF9kaXIsIGV4aXN0X29rPVRydWUpDQogICAgDQogICAgIyBTdGVwIDE6IENsZWFuIFBEQiB3aXRoIHBkYjRhbWJlciAocmVtb3ZlIHdhdGVycywgYWx0ZXJuYXRlIGNvbmZvcm1hdGlvbnMpDQogICAgY2xlYW5lZF9wZGIgPSBvcy5wYXRoLmpvaW4ob3V0cHV0X2RpciwgJ3Byb3RlaW5fY2xlYW5lZC5wZGInKQ0KICAgIGNtZCA9IFsncGRiNGFtYmVyJywgJy1pJywgcGRiX3BhdGgsICctbycsIGNsZWFuZWRfcGRiLCAnLS1kcnknLCAnLS1ub2h5ZCddDQogICAgcnVuX2NvbW1hbmQoY21kLCAiUERCNEFNQkVSIChjbGVhbikiKQ0KICAgIA0KICAgICMgU3RlcCAyOiBBZGQgaHlkcm9nZW5zIHdpdGggcmVkdWNlIGF0IHRhcmdldCBwSA0KICAgIHJlZHVjZWRfcGRiID0gb3MucGF0aC5qb2luKG91dHB1dF9kaXIsICdwcm90ZWluX3JlZHVjZWQucGRiJykNCiAgICB0cnk6DQogICAgICAgICMgcmVkdWNlIHVzZXMgLWJ1aWxkIHRvIGFkZCBoeWRyb2dlbnMsIC1ISVMgdG8gZmxpcCBoaXN0aWRpbmVzIG9wdGltYWxseQ0KICAgICAgICBjbWQgPSBbJ3JlZHVjZScsICctYnVpbGQnLCAnLWhpcycsIGNsZWFuZWRfcGRiXQ0KICAgICAgICBwcmludChmIi0tPiBSdW5uaW5nOiBBZGQgaHlkcm9nZW5zIHdpdGggcmVkdWNlIikNCiAgICAgICAgcHJpbnQoZiIgICAgQ29tbWFuZDogeycgJy5qb2luKGNtZCl9IikNCiAgICAgICAgcHJvY2VzcyA9IHN1YnByb2Nlc3MuUG9wZW4oDQogICAgICAgICAgICBjbWQsIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsIHN0ZGVycj1zdWJwcm9jZXNzLlBJUEUsIHRleHQ9VHJ1ZQ0KICAgICAgICApDQogICAgICAgIHN0ZG91dCwgc3RkZXJyID0gcHJvY2Vzcy5jb21tdW5pY2F0ZSgpDQogICAgICAgIA0KICAgICAgICBpZiBwcm9jZXNzLnJldHVybmNvZGUgPT0gMDoNCiAgICAgICAgICAgIHdpdGggb3BlbihyZWR1Y2VkX3BkYiwgJ3cnKSBhcyBmOg0KICAgICAgICAgICAgICAgIGYud3JpdGUoc3Rkb3V0KQ0KICAgICAgICAgICAgcHJpbnQoZiIgICAgSHlkcm9nZW5zIGFkZGVkIHN1Y2Nlc3NmdWxseSIpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBwcmludChmIiAgICBXQVJOSU5HOiByZWR1Y2UgZmFpbGVkLCBjb250aW51aW5nIHdpdGggY2xlYW5lZCBQREIiKQ0KICAgICAgICAgICAgcHJpbnQoZiIgICAgU1RERVJSOiB7c3RkZXJyWzoyMDBdfSIpDQogICAgICAgICAgICByZWR1Y2VkX3BkYiA9IGNsZWFuZWRfcGRiDQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOg0KICAgICAgICBwcmludChmIiAgICBXQVJOSU5HOiByZWR1Y2Ugbm90IGZvdW5kLCBza2lwcGluZyBoeWRyb2dlbiBhZGRpdGlvbiIpDQogICAgICAgIHJlZHVjZWRfcGRiID0gY2xlYW5lZF9wZGINCiAgICANCiAgICAjIFN0ZXAgMzogQXNzaWduIGhpc3RpZGluZSBwcm90b25hdGlvbiBzdGF0ZXMgYmFzZWQgb24gcEgNCiAgICBwcm90ZWluX291dCA9IG9zLnBhdGguam9pbihvdXRwdXRfZGlyLCAncHJvdGVpbl9maXhlZC5wZGInKQ0KICAgIGFzc2lnbl9oaXN0aWRpbmVfcHJvdG9uYXRpb24ocmVkdWNlZF9wZGIsIHByb3RlaW5fb3V0LCBwSCkNCiAgICANCiAgICAjIHBIIHdhcm5pbmdzDQogICAgaWYgcEggPCA1LjA6DQogICAgICAgIHByaW50KGYiICAgIFdBUk5JTkc6IExvdyBwSCAoe3BIfSkgLSBBc3AvR2x1IG1heSBuZWVkIHByb3RvbmF0aW9uIChBU0gvR0xIKSIpDQogICAgICAgIHByaW50KGYiICAgICAgICAgICAgIENvbnNpZGVyIG1hbnVhbCByZXZpZXcgb2YgY2FyYm94eWxhdGUgcmVzaWR1ZXMiKQ0KICAgIGVsaWYgcEggPiA5LjA6DQogICAgICAgIHByaW50KGYiICAgIFdBUk5JTkc6IEhpZ2ggcEggKHtwSH0pIC0gTHlzL0N5cy9UeXIgbWF5IG5lZWQgZGVwcm90b25hdGlvbiIpDQogICAgICAgIHByaW50KGYiICAgICAgICAgICAgIENvbnNpZGVyIG1hbnVhbCByZXZpZXcgb2YgdGl0cmF0YWJsZSByZXNpZHVlcyIpDQogICAgDQogICAgIyBLQ1gtc3BlY2lmaWMgd2FybmluZw0KICAgIGlmIHBIIDwgNi4wOg0KICAgICAgICBwcmludChmIiAgICBXQVJOSU5HOiBLQ1ggY2FyYmFtYXRlIGlzIHBILXNlbnNpdGl2ZSAocEthIH41LjUpIikNCiAgICAgICAgcHJpbnQoZiIgICAgICAgICAgICAgQXQgcEgge3BIfSwgS0NYIG1heSBiZSBwYXJ0aWFsbHkgcHJvdG9uYXRlZCIpDQogICAgDQogICAgcHJpbnQoZiItLT4gUHJvdGVpbiBwcmVwYXJlZDoge3Byb3RlaW5fb3V0fSIpDQogICAgcmV0dXJuIHByb3RlaW5fb3V0DQoNCmRlZiBhc3NpZ25faGlzdGlkaW5lX3Byb3RvbmF0aW9uKGlucHV0X3BkYiwgb3V0cHV0X3BkYiwgdGFyZ2V0X3BIKToNCiAgICAiIiINCiAgICBBc3NpZ24gaGlzdGlkaW5lIHByb3RvbmF0aW9uIHN0YXRlcyBiYXNlZCBvbiB0YXJnZXQgcEguDQogICAgDQogICAgSGlzdGlkaW5lIHBLYSB+Ni4wOg0KICAgIC0gcEggPCA2LjA6IEhJUCAoZG91Ymx5IHByb3RvbmF0ZWQsICsxIGNoYXJnZSkNCiAgICAtIHBIIDYuMC03LjA6IE1peGVkIEhJRC9ISUUgKHNpbmdseSBwcm90b25hdGVkLCBuZXV0cmFsKQ0KICAgIC0gcEggPiA3LjA6IEhJRSBwcmVmZXJyZWQgKGVwc2lsb24tcHJvdG9uYXRlZCwgbmV1dHJhbCkNCiAgICANCiAgICBUTGVhcCByZWNvZ25pemVzOiBISVMgLT4gSElFLCBISUQgLT4gSElELCBISVAgLT4gSElQDQogICAgIiIiDQogICAgcHJpbnQoZiIgICAgQXNzaWduaW5nIGhpc3RpZGluZSBwcm90b25hdGlvbiBmb3IgcEgge3RhcmdldF9wSH0iKQ0KICAgIA0KICAgICMgRGV0ZXJtaW5lIGhpc3RpZGluZSBzdGF0ZSBiYXNlZCBvbiBwSA0KICAgIGlmIHRhcmdldF9wSCA8IDYuMDoNCiAgICAgICAgaGlzX3N0YXRlID0gJ0hJUCcgICMgRG91Ymx5IHByb3RvbmF0ZWQgKGNoYXJnZWQpDQogICAgICAgIHByaW50KGYiICAgICAgcEggPCA2LjA6IFVzaW5nIEhJUCAoZG91Ymx5IHByb3RvbmF0ZWQsICsxKSIpDQogICAgZWxpZiB0YXJnZXRfcEggPCA3LjA6DQogICAgICAgIGhpc19zdGF0ZSA9ICdISUQnICAjIERlbHRhLXByb3RvbmF0ZWQgKG5ldXRyYWwpIC0gZ29vZCBmb3IgSC1ib25kaW5nDQogICAgICAgIHByaW50KGYiICAgICAgcEggNi4wLTcuMDogVXNpbmcgSElEIChkZWx0YS1wcm90b25hdGVkLCBuZXV0cmFsKSIpDQogICAgZWxzZToNCiAgICAgICAgaGlzX3N0YXRlID0gJ0hJRScgICMgRXBzaWxvbi1wcm90b25hdGVkIChuZXV0cmFsKSAtIG1vc3QgY29tbW9uIGF0IHBoeXNpb2xvZ2ljYWwgcEgNCiAgICAgICAgcHJpbnQoZiIgICAgICBwSCA+PSA3LjA6IFVzaW5nIEhJRSAoZXBzaWxvbi1wcm90b25hdGVkLCBuZXV0cmFsKSIpDQogICAgDQogICAgIyBSZWFkIGFuZCBtb2RpZnkgUERCDQogICAgaGlzX2NvdW50ID0gMA0KICAgIHdpdGggb3BlbihpbnB1dF9wZGIsICdyJykgYXMgZl9pbjoNCiAgICAgICAgbGluZXMgPSBmX2luLnJlYWRsaW5lcygpDQogICAgDQogICAgd2l0aCBvcGVuKG91dHB1dF9wZGIsICd3JykgYXMgZl9vdXQ6DQogICAgICAgIGZvciBsaW5lIGluIGxpbmVzOg0KICAgICAgICAgICAgaWYgbGluZS5zdGFydHN3aXRoKCgnQVRPTScsICdIRVRBVE0nKSk6DQogICAgICAgICAgICAgICAgcmVzX25hbWUgPSBsaW5lWzE3OjIwXS5zdHJpcCgpDQogICAgICAgICAgICAgICAgaWYgcmVzX25hbWUgPT0gJ0hJUyc6DQogICAgICAgICAgICAgICAgICAgICMgUmVwbGFjZSBISVMgd2l0aCBhcHByb3ByaWF0ZSBwcm90b25hdGlvbiBzdGF0ZQ0KICAgICAgICAgICAgICAgICAgICBsaW5lID0gbGluZVs6MTddICsgZid7aGlzX3N0YXRlOjwzfScgKyBsaW5lWzIwOl0NCiAgICAgICAgICAgICAgICAgICAgaGlzX2NvdW50ICs9IDENCiAgICAgICAgICAgIGZfb3V0LndyaXRlKGxpbmUpDQogICAgDQogICAgaWYgaGlzX2NvdW50ID4gMDoNCiAgICAgICAgIyBDb3VudCB1bmlxdWUgcmVzaWR1ZXMgKGRpdmlkZSBieSB+MTAgYXRvbXMgcGVyIEhpcykNCiAgICAgICAgdW5pcXVlX2hpcyA9IGhpc19jb3VudCAvLyAxMCArICgxIGlmIGhpc19jb3VudCAlIDEwID4gMCBlbHNlIDApDQogICAgICAgIHByaW50KGYiICAgICAgUmVuYW1lZCB+e3VuaXF1ZV9oaXN9IGhpc3RpZGluZSByZXNpZHVlKHMpIHRvIHtoaXNfc3RhdGV9IikNCiAgICBlbHNlOg0KICAgICAgICBwcmludChmIiAgICAgIE5vIGhpc3RpZGluZSByZXNpZHVlcyBmb3VuZCIpDQogICAgDQogICAgcmV0dXJuIG91dHB1dF9wZGINCg0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KIyBUTEVBUCAmIFNZU1RFTSBCVUlMRElORw0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQpkZWYgZ2V0X3dhdGVyX2JveF9uYW1lKHdhdGVyX21vZGVsKToNCiAgICAiIiJHZXQgdGhlIGNvcnJlY3Qgd2F0ZXIgYm94IG5hbWUgZm9yIFRMZWFwIiIiDQogICAgd2F0ZXJfYm94ZXMgPSB7DQogICAgICAgICd0aXAzcCc6ICdUSVAzUEJPWCcsDQogICAgICAgICd0aXA0cGV3JzogJ1RJUDRQRVdCT1gnLA0KICAgICAgICAnb3BjJzogJ09QQ0JPWCcsDQogICAgICAgICdvcGMzJzogJ09QQzNCT1gnLA0KICAgICAgICAnc3BjZSc6ICdTUENCT1gnLA0KICAgIH0NCiAgICByZXR1cm4gd2F0ZXJfYm94ZXMuZ2V0KHdhdGVyX21vZGVsLmxvd2VyKCksICdUSVAzUEJPWCcpDQoNCmRlZiBjYWxjdWxhdGVfaW9uX3BhaXJzKGlvbmljX3N0cmVuZ3RoX00sIGJveF9wYWRkaW5nX0EsIGVzdGltYXRlZF9wcm90ZWluX3NpemVfQT02MCk6DQogICAgIiIiDQogICAgQ2FsY3VsYXRlIG51bWJlciBvZiBOYSsvQ2wtIGlvbiBwYWlycyBuZWVkZWQgZm9yIHRhcmdldCBpb25pYyBzdHJlbmd0aC4NCiAgICANCiAgICBBcmdzOg0KICAgICAgICBpb25pY19zdHJlbmd0aF9NOiBUYXJnZXQgaW9uaWMgc3RyZW5ndGggaW4gTW9sYXIgKGUuZy4sIDAuMTUgZm9yIDE1MCBtTSkNCiAgICAgICAgYm94X3BhZGRpbmdfQTogQm94IHBhZGRpbmcgaW4gQW5nc3Ryb21zDQogICAgICAgIGVzdGltYXRlZF9wcm90ZWluX3NpemVfQTogRXN0aW1hdGVkIHByb3RlaW4gZGlhbWV0ZXIgaW4gQW5nc3Ryb21zDQogICAgDQogICAgUmV0dXJuczoNCiAgICAgICAgTnVtYmVyIG9mIGlvbiBwYWlycyB0byBhZGQgKGFmdGVyIG5ldXRyYWxpemF0aW9uKQ0KICAgICIiIg0KICAgIGlmIGlvbmljX3N0cmVuZ3RoX00gPD0gMDoNCiAgICAgICAgcmV0dXJuIDANCiAgICANCiAgICAjIEVzdGltYXRlIGJveCBlZGdlIGxlbmd0aCAocHJvdGVpbiArIHBhZGRpbmcgb24gZWFjaCBzaWRlKQ0KICAgIGVzdGltYXRlZF9ib3hfZWRnZV9BID0gZXN0aW1hdGVkX3Byb3RlaW5fc2l6ZV9BICsgMiAqIGJveF9wYWRkaW5nX0ENCiAgICANCiAgICAjIFZvbHVtZSBpbiBsaXRlcnM6IChBbmdzdHJvbSAqIDFlLTggY20vQSleMyAqIDFlLTMgTC9jbV4zDQogICAgdm9sdW1lX2xpdGVycyA9IChlc3RpbWF0ZWRfYm94X2VkZ2VfQSAqIDFlLTgpICoqIDMgKiAxZS0zDQogICAgDQogICAgIyBOdW1iZXIgb2YgaW9uIHBhaXJzOiBjb25jZW50cmF0aW9uICogdm9sdW1lICogQXZvZ2Fkcm8ncyBudW1iZXINCiAgICAjIEZvciBOYUNsOiBpb25pY19zdHJlbmd0aCA9IGNvbmNlbnRyYXRpb24gKHNpbmNlIGJvdGggaW9ucyBhcmUgbW9ub3ZhbGVudCkNCiAgICBhdm9nYWRybyA9IDYuMDIyZTIzDQogICAgbnVtX2lvbl9wYWlycyA9IGludChpb25pY19zdHJlbmd0aF9NICogdm9sdW1lX2xpdGVycyAqIGF2b2dhZHJvKQ0KICAgIA0KICAgICMgRW5zdXJlIGF0IGxlYXN0IDEgcGFpciBpZiBpb25pYyBzdHJlbmd0aCBpcyByZXF1ZXN0ZWQNCiAgICBudW1faW9uX3BhaXJzID0gbWF4KDEsIG51bV9pb25fcGFpcnMpDQogICAgDQogICAgcHJpbnQoZiIgICAgSW9uaWMgc3RyZW5ndGggY2FsY3VsYXRpb246IikNCiAgICBwcmludChmIiAgICAgIFRhcmdldDoge2lvbmljX3N0cmVuZ3RoX00qMTAwMDouMGZ9IG1NIE5hQ2wiKQ0KICAgIHByaW50KGYiICAgICAgRXN0LiBib3ggZWRnZTogfntlc3RpbWF0ZWRfYm94X2VkZ2VfQTouMGZ9IEEiKQ0KICAgIHByaW50KGYiICAgICAgRXN0LiB2b2x1bWU6IHt2b2x1bWVfbGl0ZXJzKjFlMjQ6LjBmfSBBXjMiKQ0KICAgIHByaW50KGYiICAgICAgSW9uIHBhaXJzIHRvIGFkZDoge251bV9pb25fcGFpcnN9IikNCiAgICANCiAgICByZXR1cm4gbnVtX2lvbl9wYWlycw0KDQpkZWYgYnVpbGRfc3lzdGVtKHByb3RlaW5fcGRiLCBsaWdfbW9sMiwgbGlnX2ZyY21vZCwga2N4X2ZyY21vZCwga2N4X2xpYiwgb3V0cHV0X2Rpcik6DQogICAgIiIiQnVpbGQgc29sdmF0ZWQgc3lzdGVtIHdpdGggVExlYXAiIiINCiAgICBwcmludCgiLS0+IEJ1aWxkaW5nIFN5c3RlbSB3aXRoIFRMZWFwIikNCiAgICBvcy5tYWtlZGlycyhvdXRwdXRfZGlyLCBleGlzdF9vaz1UcnVlKQ0KICAgIA0KICAgIHRsZWFwX2luID0gb3MucGF0aC5qb2luKG91dHB1dF9kaXIsICd0bGVhcC5pbicpDQogICAgcHJtdG9wID0gb3MucGF0aC5qb2luKG91dHB1dF9kaXIsICdzeXN0ZW0ucHJtdG9wJykNCiAgICBpbnBjcmQgPSBvcy5wYXRoLmpvaW4ob3V0cHV0X2RpciwgJ3N5c3RlbS5pbnBjcmQnKQ0KICAgIHdhdGVyX2JveCA9IGdldF93YXRlcl9ib3hfbmFtZSh3YXRlcl9tb2RlbCkNCiAgICANCiAgICBzY3JpcHQgPSBmIiIiIyBUTGVhcCBpbnB1dCBzY3JpcHQgZm9yIHtqb2JfbmFtZX0NCnNvdXJjZSBsZWFwcmMucHJvdGVpbi57Zm9yY2VfZmllbGR9DQpzb3VyY2UgbGVhcHJjLndhdGVyLnt3YXRlcl9tb2RlbH0NCnNvdXJjZSBsZWFwcmMuZ2FmZjINCiIiIg0KICAgIA0KICAgIGlmIGtjeF9mcmNtb2QgYW5kIGtjeF9saWI6DQogICAgICAgIHNjcmlwdCArPSBmIiIiDQojIExvYWQgS0NYIHBhcmFtZXRlcnMNCmxvYWRhbWJlcnBhcmFtcyB7a2N4X2ZyY21vZH0NCmxvYWRvZmYge2tjeF9saWJ9DQoiIiINCiAgICANCiAgICBzY3JpcHQgKz0gZiIiIg0KIyBMb2FkIHByb3RlaW4NCm1vbCA9IGxvYWRwZGIge3Byb3RlaW5fcGRifQ0KIiIiDQogICAgDQogICAgaWYgbGlnX21vbDIgYW5kIG9zLnBhdGguZXhpc3RzKGxpZ19tb2wyKToNCiAgICAgICAgc2NyaXB0ICs9IGYiIiINCiMgTG9hZCBsaWdhbmQNCmxvYWRhbWJlcnBhcmFtcyB7bGlnX2ZyY21vZH0NCkxJRyA9IGxvYWRtb2wyIHtsaWdfbW9sMn0NCnN5c3RlbSA9IGNvbWJpbmUge3ttb2wgTElHfX0NCiIiIg0KICAgIGVsc2U6DQogICAgICAgIHNjcmlwdCArPSAic3lzdGVtID0gbW9sXG4iDQogICAgDQogICAgIyBDYWxjdWxhdGUgaW9uIHBhaXJzIGZvciBpb25pYyBzdHJlbmd0aA0KICAgIG51bV9pb25fcGFpcnMgPSBjYWxjdWxhdGVfaW9uX3BhaXJzKGlvbmljX3N0cmVuZ3RoLCBib3hfc2l6ZSkNCiAgICANCiAgICBzY3JpcHQgKz0gZiIiIg0KIyBTb2x2YXRlIGFuZCBhZGQgaW9ucw0Kc29sdmF0ZWJveCBzeXN0ZW0ge3dhdGVyX2JveH0ge2JveF9zaXplfQ0KIyBGaXJzdCBuZXV0cmFsaXplIHRoZSBzeXN0ZW0NCmFkZGlvbnMgc3lzdGVtIE5hKyAwDQphZGRpb25zIHN5c3RlbSBDbC0gMA0KIiIiDQogICAgDQogICAgIyBBZGQgYWRkaXRpb25hbCBpb25zIGZvciBpb25pYyBzdHJlbmd0aCAoaWYgcmVxdWVzdGVkKQ0KICAgIGlmIG51bV9pb25fcGFpcnMgPiAwOg0KICAgICAgICBzY3JpcHQgKz0gZiIiIg0KIyBBZGQgaW9ucyBmb3Ige2lvbmljX3N0cmVuZ3RoKjEwMDA6LjBmfSBtTSBpb25pYyBzdHJlbmd0aA0KYWRkaW9ucyBzeXN0ZW0gTmErIHtudW1faW9uX3BhaXJzfQ0KYWRkaW9ucyBzeXN0ZW0gQ2wtIHtudW1faW9uX3BhaXJzfQ0KIiIiDQogICAgDQogICAgc2NyaXB0ICs9IGYiIiJjaGVjayBzeXN0ZW0NCnNhdmVhbWJlcnBhcm0gc3lzdGVtIHtwcm10b3B9IHtpbnBjcmR9DQpzYXZlcGRiIHN5c3RlbSB7b3MucGF0aC5qb2luKG91dHB1dF9kaXIsICdzeXN0ZW1fc29sdmF0ZWQucGRiJyl9DQpxdWl0DQoiIiINCiAgICANCiAgICB3aXRoIG9wZW4odGxlYXBfaW4sICd3JykgYXMgZjoNCiAgICAgICAgZi53cml0ZShzY3JpcHQpDQogICAgDQogICAgcHJpbnQoZiItLT4gVExlYXAgc2NyaXB0IHdyaXR0ZW4gdG86IHt0bGVhcF9pbn0iKQ0KICAgIHJ1bl9jb21tYW5kKFsndGxlYXAnLCAnLWYnLCB0bGVhcF9pbl0sICJUTGVhcCIpDQogICAgDQogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKHBybXRvcCkgb3Igbm90IG9zLnBhdGguZXhpc3RzKGlucGNyZCk6DQogICAgICAgIHByaW50KCJFUlJPUjogVExlYXAgZmFpbGVkIHRvIGdlbmVyYXRlIHRvcG9sb2d5IGZpbGVzIikNCiAgICAgICAgc3lzLmV4aXQoMSkNCiAgICANCiAgICBwcm10b3Bfc2l6ZSA9IG9zLnBhdGguZ2V0c2l6ZShwcm10b3ApIC8gMTAyNA0KICAgIGlucGNyZF9zaXplID0gb3MucGF0aC5nZXRzaXplKGlucGNyZCkgLyAxMDI0DQogICAgcHJpbnQoZiItLT4gU3lzdGVtIGJ1aWx0OiB7cHJtdG9wfSAoe3BybXRvcF9zaXplOi4xZn0gS0IpLCB7aW5wY3JkfSAoe2lucGNyZF9zaXplOi4xZn0gS0IpIikNCiAgICANCiAgICByZXR1cm4gcHJtdG9wLCBpbnBjcmQNCg0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KIyBPUEVOTU0gU0lNVUxBVElPTg0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQpkZWYgZ2V0X2NvbnN0cmFpbnRfdHlwZShjb25zdHJhaW50X3N0cik6DQogICAgIiIiQ29udmVydCBjb25zdHJhaW50IHN0cmluZyB0byBPcGVuTU0gY29uc3RyYWludCB0eXBlIiIiDQogICAgaW1wb3J0IG9wZW5tbS5hcHAgYXMgYXBwDQogICAgY29uc3RyYWludF9tYXAgPSB7DQogICAgICAgICdoYm9uZHMnOiBhcHAuSEJvbmRzLA0KICAgICAgICAnYWxsYm9uZHMnOiBhcHAuQWxsQm9uZHMsDQogICAgICAgICdoYW5nbGVzJzogYXBwLkhBbmdsZXMsDQogICAgICAgICdub25lJzogTm9uZSwNCiAgICB9DQogICAgcmV0dXJuIGNvbnN0cmFpbnRfbWFwLmdldChjb25zdHJhaW50X3N0ci5sb3dlcigpLCBhcHAuSEJvbmRzKQ0KDQpkZWYgcnVuX3NpbXVsYXRpb24ocHJtdG9wX3BhdGgsIGlucGNyZF9wYXRoKToNCiAgICAiIiJSdW4gT3Blbk1NIHNpbXVsYXRpb24gb3B0aW1pemVkIGZvciBOVklESUEgQTEwMCIiIg0KICAgIHByaW50KGYiXG57Jz0nKjYwfVxuU1RBUlRJTkcgT1BFTk1NIFNJTVVMQVRJT05cbnsnPScqNjB9IikNCiAgICANCiAgICBpbXBvcnQgb3Blbm1tIGFzIG1tDQogICAgaW1wb3J0IG9wZW5tbS5hcHAgYXMgYXBwDQogICAgaW1wb3J0IG9wZW5tbS51bml0IGFzIHVuaXQNCg0KICAgIHByaW50KCItLT4gQXZhaWxhYmxlIE9wZW5NTSBQbGF0Zm9ybXM6IikNCiAgICBmb3IgaSBpbiByYW5nZShtbS5QbGF0Zm9ybS5nZXROdW1QbGF0Zm9ybXMoKSk6DQogICAgICAgIHBsYXRmb3JtID0gbW0uUGxhdGZvcm0uZ2V0UGxhdGZvcm0oaSkNCiAgICAgICAgcHJpbnQoZiIgICAge2l9OiB7cGxhdGZvcm0uZ2V0TmFtZSgpfSIpDQoNCiAgICBwcmludCgiLS0+IExvYWRpbmcgdG9wb2xvZ3kgYW5kIGNvb3JkaW5hdGVzIikNCiAgICBwcm10b3AgPSBhcHAuQW1iZXJQcm10b3BGaWxlKHBybXRvcF9wYXRoKQ0KICAgIGlucGNyZCA9IGFwcC5BbWJlcklucGNyZEZpbGUoaW5wY3JkX3BhdGgpDQogICAgcHJpbnQoZiIgICAgQXRvbXM6IHtwcm10b3AudG9wb2xvZ3kuZ2V0TnVtQXRvbXMoKX0iKQ0KICAgIHByaW50KGYiICAgIFJlc2lkdWVzOiB7cHJtdG9wLnRvcG9sb2d5LmdldE51bVJlc2lkdWVzKCl9IikNCg0KICAgIGNvbnN0cmFpbnRfdHlwZSA9IGdldF9jb25zdHJhaW50X3R5cGUoY29uc3RyYWludHMpDQogICAgDQogICAgcHJpbnQoIi0tPiBDcmVhdGluZyBzeXN0ZW0iKQ0KICAgIHN5c3RlbSA9IHBybXRvcC5jcmVhdGVTeXN0ZW0oDQogICAgICAgIG5vbmJvbmRlZE1ldGhvZD1hcHAuUE1FLA0KICAgICAgICBub25ib25kZWRDdXRvZmY9MS4wKnVuaXQubmFub21ldGVyLA0KICAgICAgICBjb25zdHJhaW50cz1jb25zdHJhaW50X3R5cGUsDQogICAgICAgIHJpZ2lkV2F0ZXI9VHJ1ZSwNCiAgICAgICAgaHlkcm9nZW5NYXNzPU5vbmUNCiAgICApDQogICAgDQogICAgc3lzdGVtLmFkZEZvcmNlKG1tLk1vbnRlQ2FybG9CYXJvc3RhdCgNCiAgICAgICAgcHJlc3N1cmUqdW5pdC5iYXIsDQogICAgICAgIHRlbXBlcmF0dXJlKnVuaXQua2VsdmluLA0KICAgICAgICAyNQ0KICAgICkpDQoNCiAgICBwcmludCgiLS0+IFNldHRpbmcgdXAgaW50ZWdyYXRvciIpDQogICAgaW50ZWdyYXRvciA9IG1tLkxhbmdldmluTWlkZGxlSW50ZWdyYXRvcigNCiAgICAgICAgdGVtcGVyYXR1cmUqdW5pdC5rZWx2aW4sDQogICAgICAgIDEuMC91bml0LnBpY29zZWNvbmQsDQogICAgICAgIHRpbWVzdGVwKnVuaXQuZmVtdG9zZWNvbmQNCiAgICApDQoNCiAgICBwcmludCgiLS0+IENvbmZpZ3VyaW5nIHBsYXRmb3JtIikNCiAgICBwbGF0Zm9ybSA9IE5vbmUNCiAgICBwcm9wZXJ0aWVzID0ge30NCiAgICANCiAgICBmb3IgcGxhdGZvcm1fbmFtZSBpbiBbZGVmYXVsdF9wbGF0Zm9ybSwgJ0NVREEnLCAnT3BlbkNMJywgJ0NQVSddOiANCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgcGxhdGZvcm0gPSBtbS5QbGF0Zm9ybS5nZXRQbGF0Zm9ybUJ5TmFtZShwbGF0Zm9ybV9uYW1lKQ0KICAgICAgICAgICAgaWYgcGxhdGZvcm1fbmFtZSA9PSAnQ1VEQSc6DQogICAgICAgICAgICAgICAgcHJvcGVydGllcyA9IHsnUHJlY2lzaW9uJzogY3VkYV9wcmVjaXNpb259DQogICAgICAgICAgICBlbGlmIHBsYXRmb3JtX25hbWUgPT0gJ09wZW5DTCc6DQogICAgICAgICAgICAgICAgcHJvcGVydGllcyA9IHsnUHJlY2lzaW9uJzogY3VkYV9wcmVjaXNpb259DQogICAgICAgICAgICBwcmludChmIi0tPiBbU1VDQ0VTU10gVXNpbmcge3BsYXRmb3JtX25hbWV9IFBsYXRmb3JtIikNCiAgICAgICAgICAgIGJyZWFrDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToNCiAgICAgICAgICAgIHByaW50KGYiLS0+IFtJTkZPXSB7cGxhdGZvcm1fbmFtZX0gbm90IGF2YWlsYWJsZToge2V9IikNCiAgICAgICAgICAgIGNvbnRpbnVlDQogICAgDQogICAgaWYgcGxhdGZvcm0gaXMgTm9uZToNCiAgICAgICAgcHJpbnQoIi0tPiBbRVJST1JdIE5vIHN1aXRhYmxlIHBsYXRmb3JtIGZvdW5kISIpDQogICAgICAgIHN5cy5leGl0KDEpDQoNCiAgICBpZiBwcm9wZXJ0aWVzOiANCiAgICAgICAgc2ltID0gYXBwLlNpbXVsYXRpb24ocHJtdG9wLnRvcG9sb2d5LCBzeXN0ZW0sIGludGVncmF0b3IsIHBsYXRmb3JtLCBwcm9wZXJ0aWVzKQ0KICAgIGVsc2U6DQogICAgICAgIHNpbSA9IGFwcC5TaW11bGF0aW9uKHBybXRvcC50b3BvbG9neSwgc3lzdGVtLCBpbnRlZ3JhdG9yLCBwbGF0Zm9ybSkNCiAgICANCiAgICBzaW0uY29udGV4dC5zZXRQb3NpdGlvbnMoaW5wY3JkLnBvc2l0aW9ucykNCiAgICBpZiBpbnBjcmQuYm94VmVjdG9yczoNCiAgICAgICAgc2ltLmNvbnRleHQuc2V0UGVyaW9kaWNCb3hWZWN0b3JzKCppbnBjcmQuYm94VmVjdG9ycykNCg0KICAgIHByaW50KGYiLS0+IFtQTEFURk9STV0ge3BsYXRmb3JtLmdldE5hbWUoKX0iKQ0KICAgIGlmIHBsYXRmb3JtLmdldE5hbWUoKSA9PSAnQ1VEQSc6DQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHByaW50KGYiICAgIERldmljZToge3BsYXRmb3JtLmdldFByb3BlcnR5VmFsdWUoc2ltLmNvbnRleHQsICdEZXZpY2VOYW1lJyl9IikNCiAgICAgICAgICAgIHByaW50KGYiICAgIFByZWNpc2lvbjoge3BsYXRmb3JtLmdldFByb3BlcnR5VmFsdWUoc2ltLmNvbnRleHQsICdQcmVjaXNpb24nKX0iKQ0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6DQogICAgICAgICAgICBwcmludChmIiAgICAoQ291bGQgbm90IHJldHJpZXZlIGRldmljZSBpbmZvOiB7ZX0pIikNCg0KICAgIHByaW50KGYiLS0+IE1pbmltaXppbmcgZW5lcmd5ICh7bWluaW1pemF0aW9uX3N0ZXBzfSBzdGVwcykuLi4iKQ0KICAgIHNpbS5taW5pbWl6ZUVuZXJneShtYXhJdGVyYXRpb25zPW1pbmltaXphdGlvbl9zdGVwcykNCiAgICBzdGF0ZSA9IHNpbS5jb250ZXh0LmdldFN0YXRlKGdldEVuZXJneT1UcnVlKQ0KICAgIHByaW50KGYiLS0+IE1pbmltaXphdGlvbiBjb21wbGV0ZS4gUG90ZW50aWFsIEVuZXJneToge3N0YXRlLmdldFBvdGVudGlhbEVuZXJneSgpfSIpDQoNCiAgICBlcXVpbF9zdGVwcyA9IGludCgoZXF1aWxpYnJhdGlvbl90aW1lICogMWU2KSAvIHRpbWVzdGVwKQ0KICAgIHByaW50KGYiLS0+IFJ1bm5pbmcgZXF1aWxpYnJhdGlvbiAoe2VxdWlsX3N0ZXBzfSBzdGVwcywge2VxdWlsaWJyYXRpb25fdGltZX0gbnMpLi4uIikNCiAgICBzaW0uc3RlcChlcXVpbF9zdGVwcykNCiAgICBwcmludCgiLS0+IEVxdWlsaWJyYXRpb24gY29tcGxldGUiKQ0KDQogICAgdG90YWxfc3RlcHMgPSBpbnQoKHByb2R1Y3Rpb25fdGltZSAqIDFlNikgLyB0aW1lc3RlcCkNCiAgICBwcmludChmIi0tPiBSdW5uaW5nIFByb2R1Y3Rpb24gTUQ6IikNCiAgICBwcmludChmIiAgICBEdXJhdGlvbjoge3Byb2R1Y3Rpb25fdGltZX0gbnMsIFN0ZXBzOiB7dG90YWxfc3RlcHN9IikNCiAgICANCiAgICBkY2RfZmlsZSA9IG9zLnBhdGguam9pbihPVVRQVVRfRElSLCAndHJhamVjdG9yeS5kY2QnKQ0KICAgIGxvZ19maWxlID0gb3MucGF0aC5qb2luKE9VVFBVVF9ESVIsICdzaW11bGF0aW9uLmxvZycpDQogICAgY2hlY2twb2ludF9maWxlID0gb3MucGF0aC5qb2luKE9VVFBVVF9ESVIsICdjaGVja3BvaW50LmNoaycpDQogICAgDQogICAgc2ltLnJlcG9ydGVycy5hcHBlbmQoYXBwLkRDRFJlcG9ydGVyKGRjZF9maWxlLCBwcm9kX3RyYWpfZnJlcSkpDQogICAgc2ltLnJlcG9ydGVycy5hcHBlbmQoYXBwLlN0YXRlRGF0YVJlcG9ydGVyKA0KICAgICAgICBsb2dfZmlsZSwgcHJvZF90cmFqX2ZyZXEsDQogICAgICAgIHN0ZXA9VHJ1ZSwgdGltZT1UcnVlLCBwb3RlbnRpYWxFbmVyZ3k9VHJ1ZSwga2luZXRpY0VuZXJneT1UcnVlLA0KICAgICAgICB0b3RhbEVuZXJneT1UcnVlLCB0ZW1wZXJhdHVyZT1UcnVlLCB2b2x1bWU9VHJ1ZSwgZGVuc2l0eT1UcnVlLCBzcGVlZD1UcnVlDQogICAgKSkNCiAgICBzaW0ucmVwb3J0ZXJzLmFwcGVuZChhcHAuQ2hlY2twb2ludFJlcG9ydGVyKGNoZWNrcG9pbnRfZmlsZSwgcHJvZF90cmFqX2ZyZXEgKiAxMCkpDQogICAgc2ltLnJlcG9ydGVycy5hcHBlbmQoYXBwLlN0YXRlRGF0YVJlcG9ydGVyKA0KICAgICAgICBzeXMuc3Rkb3V0LCBwcm9kX3RyYWpfZnJlcSAqIDEwLA0KICAgICAgICBzdGVwPVRydWUsIHRpbWU9VHJ1ZSwgc3BlZWQ9VHJ1ZSwgcmVtYWluaW5nVGltZT1UcnVlLCB0b3RhbFN0ZXBzPXRvdGFsX3N0ZXBzDQogICAgKSkNCiAgICANCiAgICBwcmludCgiLS0+IFN0YXJ0aW5nIHByb2R1Y3Rpb24gcnVuLi4uIikNCiAgICBzaW0uc3RlcCh0b3RhbF9zdGVwcykNCiAgICANCiAgICBmaW5hbF9wZGIgPSBvcy5wYXRoLmpvaW4oT1VUUFVUX0RJUiwgJ2ZpbmFsX3N0cnVjdHVyZS5wZGInKQ0KICAgIHN0YXRlID0gc2ltLmNvbnRleHQuZ2V0U3RhdGUoZ2V0UG9zaXRpb25zPVRydWUsIGdldFZlbG9jaXRpZXM9VHJ1ZSwgZ2V0RW5lcmd5PVRydWUpDQogICAgd2l0aCBvcGVuKGZpbmFsX3BkYiwgJ3cnKSBhcyBmOg0KICAgICAgICBhcHAuUERCRmlsZS53cml0ZUZpbGUoc2ltLnRvcG9sb2d5LCBzdGF0ZS5nZXRQb3NpdGlvbnMoKSwgZikNCiAgICANCiAgICBzaW0uc2F2ZUNoZWNrcG9pbnQob3MucGF0aC5qb2luKE9VVFBVVF9ESVIsICdmaW5hbF9jaGVja3BvaW50LmNoaycpKQ0KICAgIA0KICAgIHByaW50KGYiXG57Jz0nKjYwfSIpDQogICAgcHJpbnQoIi0tPiBTaW11bGF0aW9uIEZpbmlzaGVkIFN1Y2Nlc3NmdWxseSIpDQogICAgcHJpbnQoZiIgICAgVHJhamVjdG9yeToge2RjZF9maWxlfSIpDQogICAgcHJpbnQoZiIgICAgRmluYWwgc3RydWN0dXJlOiB7ZmluYWxfcGRifSIpDQogICAgcHJpbnQoZiJ7Jz0nKjYwfVxuIikNCiAgICANCiAgICByZXR1cm4gZGNkX2ZpbGUsIGZpbmFsX3BkYg0KDQojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQojIEFOQUxZU0lTDQojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQoNCmRlZiBydW5fYW5hbHlzaXMoZGNkX3BhdGgsIHBkYl9wYXRoKToNCiAgICAiIiJSdW4gdHJhamVjdG9yeSBhbmFseXNpcyAoUk1TRCkiIiINCiAgICBwcmludCgiLS0+IFJ1bm5pbmcgVHJhamVjdG9yeSBBbmFseXNpcyIpDQogICAgDQogICAgdHJ5Og0KICAgICAgICBpbXBvcnQgbWR0cmFqIGFzIG1kDQogICAgICAgIGltcG9ydCBtYXRwbG90bGliLnB5cGxvdCBhcyBwbHQNCiAgICAgICAgaW1wb3J0IG51bXB5IGFzIG5wDQogICAgICAgIA0KICAgICAgICBwcmludChmIiAgICBMb2FkaW5nIHRyYWplY3Rvcnk6IHtkY2RfcGF0aH0iKQ0KICAgICAgICB0cmFqID0gbWQubG9hZChkY2RfcGF0aCwgdG9wPXBkYl9wYXRoKQ0KICAgICAgICBwcmludChmIiAgICBMb2FkZWQ6IHt0cmFqLm5fZnJhbWVzfSBmcmFtZXMsIHt0cmFqLm5fYXRvbXN9IGF0b21zIikNCiAgICAgICAgDQogICAgICAgIHByaW50KCIgICAgQ2FsY3VsYXRpbmcgYmFja2JvbmUgUk1TRC4uLiIpDQogICAgICAgIGJhY2tib25lID0gdHJhai50b3BvbG9neS5zZWxlY3QoJ2JhY2tib25lJykNCiAgICAgICAgaWYgbGVuKGJhY2tib25lKSA9PSAwOg0KICAgICAgICAgICAgcHJpbnQoIiAgICBXQVJOSU5HOiBObyBiYWNrYm9uZSBhdG9tcywgdXNpbmcgaGVhdnkgYXRvbXMiKQ0KICAgICAgICAgICAgYmFja2JvbmUgPSB0cmFqLnRvcG9sb2d5LnNlbGVjdCgnbm90IGVsZW1lbnQgSCcpDQogICAgICAgIA0KICAgICAgICBybXNkID0gbWQucm1zZCh0cmFqLCB0cmFqWzBdLCBhdG9tX2luZGljZXM9YmFja2JvbmUpDQogICAgICAgIHJtc2RfYW5nc3Ryb20gPSBybXNkICogMTANCiAgICAgICAgdGltZV9ucyA9IHRyYWoudGltZSAvIDEwMDANCiAgICAgICAgDQogICAgICAgIHBsdC5maWd1cmUoZmlnc2l6ZT0oMTAsIDYpKQ0KICAgICAgICBwbHQucGxvdCh0aW1lX25zLCBybXNkX2FuZ3N0cm9tLCBsaW5ld2lkdGg9MS41LCBjb2xvcj0nIzJFODZBQicpDQogICAgICAgIHBsdC54bGFiZWwoJ1RpbWUgKG5zKScsIGZvbnRzaXplPTEyKQ0KICAgICAgICBwbHQueWxhYmVsKCdCYWNrYm9uZSBSTVNEIChBbmdzdHJvbSknLCBmb250c2l6ZT0xMikNCiAgICAgICAgcGx0LnRpdGxlKGYnQmFja2JvbmUgUk1TRCB2cyBUaW1lXG5NZWFuOiB7cm1zZF9hbmdzdHJvbS5tZWFuKCk6LjJmfSBBLCBNYXg6IHtybXNkX2FuZ3N0cm9tLm1heCgpOi4yZn0gQScpDQogICAgICAgIHBsdC5ncmlkKFRydWUsIGFscGhhPTAuMykNCiAgICAgICAgcGx0LnRpZ2h0X2xheW91dCgpDQogICAgICAgIA0KICAgICAgICBybXNkX3Bsb3QgPSBvcy5wYXRoLmpvaW4oT1VUUFVUX0RJUiwgJ3Jtc2RfYW5hbHlzaXMucG5nJykNCiAgICAgICAgcGx0LnNhdmVmaWcocm1zZF9wbG90LCBkcGk9MTUwLCBiYm94X2luY2hlcz0ndGlnaHQnKQ0KICAgICAgICBwbHQuY2xvc2UoKQ0KICAgICAgICANCiAgICAgICAgcHJpbnQoZiItLT4gUk1TRCBBbmFseXNpczogTWVhbj17cm1zZF9hbmdzdHJvbS5tZWFuKCk6LjJmfUEsIE1heD17cm1zZF9hbmdzdHJvbS5tYXgoKTouMmZ9QSIpDQogICAgICAgIHByaW50KGYiICAgIFBsb3Qgc2F2ZWQ6IHtybXNkX3Bsb3R9IikNCiAgICAgICAgDQogICAgICAgIHJtc2RfZGF0YSA9IG9zLnBhdGguam9pbihPVVRQVVRfRElSLCAncm1zZF9kYXRhLnR4dCcpDQogICAgICAgIG5wLnNhdmV0eHQocm1zZF9kYXRhLCBucC5jb2x1bW5fc3RhY2soW3RpbWVfbnMsIHJtc2RfYW5nc3Ryb21dKSwNCiAgICAgICAgICAgICAgICAgICBoZWFkZXI9J1RpbWUobnMpIFJNU0QoQW5nc3Ryb20pJywgZm10PSclLjRmJykNCiAgICAgICAgDQogICAgZXhjZXB0IEltcG9ydEVycm9yIGFzIGU6DQogICAgICAgIHByaW50KGYiLS0+IEFuYWx5c2lzIHNraXBwZWQ6IE1pc3NpbmcgbGlicmFyeSAoe2V9KSIpDQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOiANCiAgICAgICAgcHJpbnQoZiItLT4gQW5hbHlzaXMgZmFpbGVkOiB7ZX0iKQ0KICAgICAgICB0cmFjZWJhY2sucHJpbnRfZXhjKCkNCg0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KIyBNQUlOIEVYRUNVVElPTg0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOg0KICAgIHRyeToNCiAgICAgICAgcHJpbnQoZiJcbnsnPScqNjB9IikNCiAgICAgICAgcHJpbnQoIk9wZW5NTSBNRCBTaW11bGF0aW9uIHdpdGggS0NYIFN1cHBvcnQiKQ0KICAgICAgICBwcmludChmIkpvYiBOYW1lOiB7am9iX25hbWV9IikNCiAgICAgICAgcHJpbnQoZiJ7Jz0nKjYwfVxuIikNCiAgICAgICAgDQogICAgICAgIHByaW50X2dwdV9pbmZvKCkNCiAgICAgICAgDQogICAgICAgIHByaW50KCJcbi0tPiBTaW11bGF0aW9uIFBhcmFtZXRlcnM6IikNCiAgICAgICAgcHJpbnQoZiIgICAgRm9yY2UgRmllbGQ6IHtmb3JjZV9maWVsZH0sIFdhdGVyOiB7d2F0ZXJfbW9kZWx9IikNCiAgICAgICAgcHJpbnQoZiIgICAgQm94OiB7Ym94X3NpemV9QSwgVGVtcDoge3RlbXBlcmF0dXJlfUssIFByZXNzOiB7cHJlc3N1cmV9YmFyIikNCiAgICAgICAgcHJpbnQoZiIgICAgVGltZXN0ZXA6IHt0aW1lc3RlcH1mcywgRXF1aWw6IHtlcXVpbGlicmF0aW9uX3RpbWV9bnMsIFByb2Q6IHtwcm9kdWN0aW9uX3RpbWV9bnMiKQ0KICAgICAgICANCiAgICAgICAgcHJpbnQoIlxuLS0+IFNldHRpbmcgdXAgZGlyZWN0b3JpZXMiKQ0KICAgICAgICBmb3IgZCBpbiBbT1VUUFVUX0RJUiwgUFJFUF9ESVIsIFBBUkFNU19ESVJdOiANCiAgICAgICAgICAgIG9zLm1ha2VkaXJzKGQsIGV4aXN0X29rPVRydWUpDQogICAgICAgICAgICBwcmludChmIiAgICBDcmVhdGVkOiB7ZH0iKQ0KICAgICAgICANCiAgICAgICAgcHJpbnQoIlxuLS0+IFZhbGlkYXRpbmcgaW5wdXRzIikNCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKFBEQl9GSUxFX0lOUFVUKToNCiAgICAgICAgICAgIHByaW50KGYiRkFUQUwgRVJST1I6IE1pc3NpbmcgUERCIGZpbGUgYXQge1BEQl9GSUxFX0lOUFVUfSIpDQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cygnaW5wdXRzJyk6DQogICAgICAgICAgICAgICAgcHJpbnQoZiIgICAgQ29udGVudHMgb2YgaW5wdXRzLzoge29zLmxpc3RkaXIoJ2lucHV0cycpfSIpDQogICAgICAgICAgICBzeXMuZXhpdCgxKQ0KICAgICAgICBwcmludChmIiAgICBGb3VuZCBQREI6IHtQREJfRklMRV9JTlBVVH0iKQ0KICAgICAgICANCiAgICAgICAgaGFzX2xpZ2FuZCA9IG9zLnBhdGguZXhpc3RzKExJR0FORF9GSUxFX0lOUFVUKQ0KICAgICAgICBpZiBoYXNfbGlnYW5kOiANCiAgICAgICAgICAgIHByaW50KGYiICAgIEZvdW5kIExpZ2FuZDoge0xJR0FORF9GSUxFX0lOUFVUfSIpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBwcmludCgiICAgIE5vIGxpZ2FuZCBmaWxlIChwcm90ZWluLW9ubHkgc2ltdWxhdGlvbikiKQ0KICAgICAgICANCiAgICAgICAgcHJpbnQoIlxuLS0+IExvYWRpbmcgS0NYIHBhcmFtZXRlcnMiKQ0KICAgICAgICBrY3hfZnJjbW9kLCBrY3hfbGliID0gZ2V0X2tjeF9wYXJhbWV0ZXJzKCkNCiAgICAgICAgDQogICAgICAgICMgVmFsaWRhdGUgS0NYIHJlc2lkdWVzIGluIGlucHV0IFBEQg0KICAgICAgICBwcmludCgiXG4tLT4gQ2hlY2tpbmcgZm9yIEtDWCByZXNpZHVlcyIpDQogICAgICAgIGtjeF92YWxpZGF0aW9uID0gdmFsaWRhdGVfa2N4X3Jlc2lkdWVzKFBEQl9GSUxFX0lOUFVUKQ0KICAgICAgICBpZiBrY3hfdmFsaWRhdGlvblsnZXJyb3JzJ106DQogICAgICAgICAgICBwcmludCgiXG4gICAgV0FSTklORzogS0NYIHZhbGlkYXRpb24gZXJyb3JzIGRldGVjdGVkISIpDQogICAgICAgICAgICBwcmludCgiICAgIFRoZSBzaW11bGF0aW9uIHdpbGwgY29udGludWUsIGJ1dCByZXN1bHRzIG1heSBiZSBpbmNvcnJlY3QuIikNCiAgICAgICAgICAgIHByaW50KCIgICAgQ29uc2lkZXIgZml4aW5nIEtDWCBhdG9tIG5hbWVzIHRvIG1hdGNoIGtjeC5saWIgYmVmb3JlIHByb2NlZWRpbmcuIikNCiAgICAgICAgDQogICAgICAgIGxpZ19tb2wyLCBsaWdfZnJjbW9kID0gTm9uZSwgTm9uZQ0KICAgICAgICBpZiBoYXNfbGlnYW5kOiANCiAgICAgICAgICAgIHByaW50KCJcbi0tPiBQcmVwYXJpbmcgbGlnYW5kIikNCiAgICAgICAgICAgIGxpZ19tb2wyLCBsaWdfZnJjbW9kID0gcHJlcGFyZV9saWdhbmQoTElHQU5EX0ZJTEVfSU5QVVQsIGxpZ2FuZF9jaGFyZ2UsIFBSRVBfRElSKQ0KICAgICAgICANCiAgICAgICAgcHJpbnQoIlxuLS0+IFByZXBhcmluZyBwcm90ZWluIikNCiAgICAgICAgZml4ZWRfcHJvdGVpbiA9IHByZXBhcmVfcHJvdGVpbihQREJfRklMRV9JTlBVVCwgUFJFUF9ESVIpDQogICAgICAgIA0KICAgICAgICBwcmludCgiXG4tLT4gQnVpbGRpbmcgc3lzdGVtIHRvcG9sb2d5IikNCiAgICAgICAgcHJtdG9wLCBpbnBjcmQgPSBidWlsZF9zeXN0ZW0oDQogICAgICAgICAgICBmaXhlZF9wcm90ZWluLCBsaWdfbW9sMiwgbGlnX2ZyY21vZCwNCiAgICAgICAgICAgIGtjeF9mcmNtb2QsIGtjeF9saWIsIE9VVFBVVF9ESVINCiAgICAgICAgKQ0KICAgICAgICANCiAgICAgICAgcHJpbnQoIlxuLS0+IFJ1bm5pbmcgT3Blbk1NIHNpbXVsYXRpb24iKQ0KICAgICAgICB0cmFqX3BhdGgsIGZpbmFsX3BkYiA9IHJ1bl9zaW11bGF0aW9uKHBybXRvcCwgaW5wY3JkKQ0KICAgICAgICANCiAgICAgICAgcHJpbnQoIlxuLS0+IEFuYWx5emluZyB0cmFqZWN0b3J5IikNCiAgICAgICAgcnVuX2FuYWx5c2lzKHRyYWpfcGF0aCwgZmluYWxfcGRiKQ0KICAgICAgICANCiAgICAgICAgcHJpbnQoZiJcbnsnPScqNjB9IikNCiAgICAgICAgcHJpbnQoIlNJTVVMQVRJT04gQ09NUExFVEUiKQ0KICAgICAgICBwcmludChmInsnPScqNjB9IikNCiAgICAgICAgcHJpbnQoZiJKb2I6IHtqb2JfbmFtZX0iKQ0KICAgICAgICBwcmludChmIlJlc3VsdHM6IHtPVVRQVVRfRElSfS8iKQ0KICAgICAgICBwcmludChmInsnPScqNjB9XG4iKQ0KICAgICAgICANCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6IA0KICAgICAgICBwcmludChmIlxuQ1JJVElDQUwgRkFJTFVSRToge2V9IikNCiAgICAgICAgdHJhY2ViYWNrLnByaW50X2V4YygpDQogICAgICAgIHN5cy5leGl0KDEp" | base64 -d > /app/entrypoint.py

ENTRYPOINT ["python", "/app/entrypoint.py"]
